<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ヒヤリハット投稿マップ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 400px; width: 100%; }
    body { font-family: sans-serif; margin: 10px; }
    label, select, textarea, button { display: block; margin: 8px 0; }
    .region-buttons button { margin-right: 5px; }
  </style>
</head>
<body>
  <h2>ヒヤリハット投稿マップ</h2>

  <div id="map"></div>

  <div class="region-buttons">
    <button onclick="jumpTo('旧豊岡市')">旧豊岡市</button>
    <button onclick="jumpTo('城崎')">城崎</button>
    <button onclick="jumpTo('竹野')">竹野</button>
    <button onclick="jumpTo('日高')">日高</button>
    <button onclick="jumpTo('出石')">出石</button>
    <button onclick="jumpTo('但東')">但東</button>
  </div>

  <input type="text" id="addressInput" placeholder="豊岡市○○" />
  <button onclick="searchAddress()">検索</button>

  <label>ジャンル（1つ選択）</label>
  <select id="perspective">
    <option>自動車走行時</option>
    <option>歩行時</option>
    <option>自転車運転時</option>
  </select>

  <label>危険内容（複数選択）</label>
  <label><input type="checkbox" value="道が狭い・すれ違いにくい" />道が狭い</label>
  <label><input type="checkbox" value="見通しが悪い" />見通しが悪い</label>
  <label><input type="checkbox" value="車のスピードが早い" />スピードが早い</label>
  <label><input type="checkbox" value="信号・標識がわかりづらい／ない" />信号・標識なし</label>
  <label><input type="checkbox" value="子ども・高齢者がよく通る" />子ども・高齢者が通る</label>
  <label><input type="checkbox" value="駐車・停車の車が多い" />駐車・停車が多い</label>

  <label>補足コメント（任意）</label>
  <textarea id="comment" rows="3"></textarea>

  <button onclick="submitPin()">送信してマップに追加</button>
  <button onclick="clearPins()">ピンをすべて消す</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([35.544444, 134.826667], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let selectedLatLng = null;
    let userPins = [];

    map.on('click', function (e) {
      selectedLatLng = e.latlng;
      L.popup().setLatLng(e.latlng).setContent("ここに投稿します").openOn(map);
    });

    function getSelectedDangers() {
      return Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(cb => cb.value).join(", ");
    }

    function submitPin() {
      if (!selectedLatLng) {
        alert("まず地図をクリックして場所を選んでください。");
        return;
      }

      const params = new URLSearchParams();
      params.append("lat", selectedLatLng.lat);
      params.append("lng", selectedLatLng.lng);
      params.append("perspective", document.getElementById("perspective").value);
      params.append("dangers", getSelectedDangers());
      params.append("comment", document.getElementById("comment").value);

      fetch("https://script.google.com/macros/s/AKfycbzM6n_bQj3luIpZj1e5BDQQEIIDEFBETwJpBge8od-s7C6gdqwbdARM-CWKvqp3mMTdnA/exec", {
        method: "POST",
        body: params
      })
      .then(res => res.text())
      .then(text => {
        if (text === "OK") {
          addPin({
            lat: selectedLatLng.lat,
            lng: selectedLatLng.lng,
            perspective: document.getElementById("perspective").value,
            dangers: getSelectedDangers(),
            comment: document.getElementById("comment").value
          });
        } else {
          alert("送信失敗：" + text);
        }
      })
      .catch(err => {
        alert("送信エラー: " + err.message);
      });
    }

    function addPin(data) {
      const color = {
        "自動車走行時": "red",
        "歩行時": "blue",
        "自転車運転時": "green"
      }[data.perspective] || "gray";

      const marker = L.marker([data.lat, data.lng], {
        icon: L.icon({
          iconUrl: `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
          iconSize: [32, 32]
        })
      }).addTo(map);

      marker.bindPopup(`<b>${data.perspective}</b><br>${data.dangers}<br>${data.comment || ""}`);
      userPins.push(marker);

      const stored = JSON.parse(localStorage.getItem("userPins") || "[]");
      stored.push(data);
      localStorage.setItem("userPins", JSON.stringify(stored));
    }

    function clearPins() {
      if (confirm("すべてのピンを削除しますか？")) {
        userPins.forEach(m => map.removeLayer(m));
        userPins = [];
        localStorage.removeItem("userPins");
      }
    }

    function jumpTo(area) {
      const places = {
        "旧豊岡市": [35.544444, 134.826667],
        "城崎": [35.6237, 134.8191],
        "竹野": [35.6201, 134.7045],
        "日高": [35.5488, 134.8885],
        "出石": [35.4435, 134.8793],
        "但東": [35.3572, 134.9623]
      };
      const coords = places[area];
      if (coords) map.setView(coords, 14);
    }

    function searchAddress() {
      const query = document.getElementById("addressInput").value + " 豊岡市";
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            map.setView([lat, lon], 16);
          } else {
            alert("住所が見つかりませんでした。");
          }
        });
    }

    window.onload = () => {
      const saved = JSON.parse(localStorage.getItem("userPins") || "[]");
      saved.forEach(addPin);
    };
  </script>
</body>
</html>
